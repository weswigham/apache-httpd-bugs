From nobody@hyperreal.com  Fri May 16 12:01:39 1997
Received: (from nobody@localhost)
	by hyperreal.com (8.8.5/8.8.5) id MAA03225;
	Fri, 16 May 1997 12:01:39 -0700 (PDT)
Message-Id: <199705161901.MAA03225@hyperreal.com>
Date: Fri, 16 May 1997 12:01:39 -0700 (PDT)
From: Richard.Seaman@hyperreal.com, "Jr." <dick@tar.com>
Reply-To: dick@tar.com
To: apbugs@hyperreal.com
Subject: httpd exits on Signal 11 in inted mode after keep alive timeout
X-Send-Pr-Version: 3.2

>Number:         592
>Category:       general
>Synopsis:       httpd exits on Signal 11 in inted mode after keep alive timeout
>Confidential:   no
>Severity:       non-critical
>Priority:       medium
>Responsible:    apache
>State:          closed
>Class:          sw-bug
>Submitter-Id:   apache
>Arrival-Date:   Fri May 16 12:10:00 1997
>Originator:     dick@tar.com
>Organization:
>Release:        1.2b10
>Environment:
FreeBSD ns.tar.com 2.2-STABLE FreeBSD 2.2-STABLE #0: Thu May 15 21:02:22 CDT 1997
>Description:
Syslog reports (example):
May 16 13:22:42 ns /kernel: pid 2754 (httpd), uid 1004: exited on signal 11
May 16 13:23:10 ns /kernel: pid 2755 (httpd), uid 1004: exited on signal 11

after access from at least some versions of Netscape (eg. Version 2.2 for OS/2
and 3.0 gold for Win 95).

httpd is running in inetd mode with following options:
KeepAlive On
KeepAliveTimeout 15
BrowserMatch Mozilla/2 nokeepalive
>How-To-Repeat:

>Fix:
When running in inetd mode, when the keep alive timer expires 
the function timeout is invoked.  At line 375 in http_main.c
the following code is executed:

    if (!current_conn) {
	ap_longjmp (jmpbuffer, 1);
    }

In inetd mode current_conn is never set, so it is NULL.  Also,
ap_setjmp is never called in inetd mode, so jmpbuffer is not
initialized.  I believe that the signal 11 is generated by the
call to ap_longjmp on the unitialized jmpbuffer.

One work around is to set:

current_conn = conn;

after line 2456 of http_main.c.

However, it is not clear to me whether this is the exact correct
solution, or whether the function timeout needs to be modified for
inetd keep alive timeout processing.

It seems that even with this fix, current_conn could still be NULL,
though this is unlikely?  However, the httpd process may terminate
before keep alive timeout expires in this case??  You'll have to check
>Audit-Trail:
State-Changed-From-To: open-closed
State-Changed-By: dgaudet
State-Changed-When: Thu Sep 25 00:08:37 PDT 1997
State-Changed-Why:
Should be fixed in 1.2.5.

Dean

From: Dean Gaudet <dgaudet@arctic.org>
To: dick@tar.com
Subject: general/592: httpd exits on Signal 11 in inted mode after keep alive timeout
Date: Thu, 25 Sep 1997 00:08:14 -0700 (PDT)

 
 The following patch, which has been applied to the code, should solve this
 problem.
 
 Dean
 
 ---------- Forwarded message ----------
 Date: Mon, 22 Sep 1997 14:58:57 -0700 (PDT)
 From: Dean Gaudet <dgaudet@hyperreal.org>
 Reply-To: new-httpd@apache.org
 To: apache-cvs@hyperreal.org
 Subject: cvs commit: apache/src CHANGES http_main.c
 
 dgaudet     97/09/22 14:58:56
 
   Modified:    src      Tag: APACHE_1_2_X CHANGES http_main.c
   Log:
   inetd mode uses timeouts without setting up the jmpbuf
   
   PR:		1064
   Reviewed by:	Marc Slemko, Roy Fielding
   
   Revision  Changes    Path
   No                   revision
   
   
   No                   revision
   
   
   1.286.2.54 +3 -0      apache/src/CHANGES
   
   Index: CHANGES
   ===================================================================
   RCS file: /export/home/cvs/apache/src/CHANGES,v
   retrieving revision 1.286.2.53
   retrieving revision 1.286.2.54
   diff -u -r1.286.2.53 -r1.286.2.54
   --- CHANGES	1997/09/22 21:55:23	1.286.2.53
   +++ CHANGES	1997/09/22 21:58:49	1.286.2.54
   @@ -1,5 +1,8 @@
    Changes with Apache 1.2.5
    
   +  *) Inetd mode (which is buggy) uses timeouts without having setup the
   +     jmpbuffer. [Dean Gaudet] PR#1064
   +
      *) Work around problem under Linux where a child will start looping
         reporting a select error over and over.
         [Rick Franchuk <rickf@transpect.net>] PR#1107
   
   
   
   1.149.2.10 +3 -0      apache/src/http_main.c
   
   Index: http_main.c
   ===================================================================
   RCS file: /export/home/cvs/apache/src/http_main.c,v
   retrieving revision 1.149.2.9
   retrieving revision 1.149.2.10
   diff -u -r1.149.2.9 -r1.149.2.10
   --- http_main.c	1997/09/22 21:55:25	1.149.2.9
   +++ http_main.c	1997/09/22 21:58:51	1.149.2.10
   @@ -2471,6 +2471,9 @@
              GETUSERMODE();
          }
    #endif
   +        if (ap_setjmp (jmpbuffer)) {
   +	    exit (0);
   +        }
    
    	c = sizeof(sa_client);
    	if ((getpeername(fileno(stdin), &sa_client, &c)) < 0)
   
   
   
 
>Unformatted:

>Last-Modified:  Thu Sep 25 00:08:38 PDT 1997


