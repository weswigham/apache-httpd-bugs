Received: (qmail 50326 invoked by uid 65534); 9 Apr 2000 01:37:40 -0000
Message-Id: <20000409013740.50325.qmail@locus.apache.org>
Date: 9 Apr 2000 01:37:40 -0000
From: Ted Keller <keller@bfg.com>
Reply-To: keller@bfg.com
To: submit@bugz.apache.org
Subject: Proxy cannot connect to many IIS 4.0 sites
X-Send-Pr-Version: 3.110

>Number:         5972
>Category:       mod_proxy
>Synopsis:       Proxy cannot connect to many IIS 4.0 sites
>Confidential:   no
>Severity:       critical
>Priority:       medium
>Responsible:    apache
>State:          open
>Class:          sw-bug
>Submitter-Id:   apache
>Arrival-Date:   Sat Apr 08 18:40:00 PDT 2000
>Closed-Date:    
>Last-Modified:  Wed May 10 16:20:01 PDT 2000
>Originator:     keller@bfg.com
>Release:        1.3.9
>Organization:
apache
>Environment:
Solaris 2.7
GCC-2.95.2
SunOS ns2.bfg.com 5.7 Generic_106541-05 sun4u sparc SUNW,Ultra-4
>Description:
Recently, we've noted a growing number of IIS 4.0 sites which we cannot connect to.  The server gets hung in a read state which eventually times out.

snoops of the connection show that data is transfered - however on the failed sites, the final 0a0d character sequence is missing.

Browers direct or through socks do not have the problem.  However, socks5 indicates the read completed abnormally.

Attached is a small snoop snippit...

ns1.bfg.com# ns1.bfg.com% more tric.lis
  1   0.00000 gateway.bfg.com -> 141.110.21.7 TCP D=80 S=62088 Syn Seq=146627370
3 Len=0 Win=64240

           0: 00d0 bbd3 16a0 0800 208c f386 0800 4500    ........ .....E.
          16: 002c 79a5 4000 ff06 def2 83bb fd02 8d6e    .,y.@..........n
          32: 1507 f288 0050 5765 8fa7 0000 0000 6002    .....PWe......`.
          48: faf0 a01c 0000 0204 05b4                   ..........

  2   0.00925 141.110.21.7 -> gateway.bfg.com TCP D=62088 S=80 Syn Ack=146627370
4 Seq=96813986 Len=0 Win=8760

           0: 0800 208c f386 00d0 bbd3 16a0 0800 4500    .. ...........E.
          16: 002c 667a 4000 7806 791e 8d6e 1507 83bb    .,fz@.x.y..n....
          32: fd02 0050 f288 05c5 43a2 5765 8fa8 6012    ...P....C.We..`.
          48: 2238 2f5d 0000 0204 05b4 0000              "8/]........

  3   0.00004 gateway.bfg.com -> 141.110.21.7 TCP D=80 S=62088     Ack=96813987 
Seq=1466273704 Len=0 Win=64240

           0: 00d0 bbd3 16a0 0800 208c f386 0800 4500    ........ .....E.
          16: 0028 79a6 4000 ff06 def5 83bb fd02 8d6e    .(y.@..........n
          32: 1507 f288 0050 5765 8fa8 05c5 43a3 5010    .....PWe....C.P.
          48: faf0 6e61 0000                             ú.na..

  4   0.00136 gateway.bfg.com -> 141.110.21.7 TCP D=80 S=62088     Ack=96813987 
Seq=1466273704 Len=254 Win=64240

           0: 00d0 bbd3 16a0 0800 208c f386 0800 4500    ........ .....E.
          16: 0126 79a7 4000 ff06 ddf6 83bb fd02 8d6e    .&y.@..........n
          32: 1507 f288 0050 5765 8fa8 05c5 43a3 5018    .....PWe....C.P.
          48: faf0 8485 0000 4745 5420 2f6d 7962 622e    ......GET /mybb.
          64: 6874 6d6c 2048 5454 502f 312e 300d 0a48    html HTTP/1.0..H
          80: 6f73 743a 2064 6c63 6262 2e74 7269 2d63    ost: dlcbb.tri-c
          96: 2e63 632e 6f68 2e75 730d 0a41 6363 6570    .cc.oh.us..Accep
         112: 743a 2069 6d61 6765 2f67 6966 2c20 696d    t: image/gif, im
         128: 6167 652f 782d 7862 6974 6d61 702c 2069    age/x-xbitmap, i
         144: 6d61 6765 2f6a 7065 672c 2069 6d61 6765    mage/jpeg, image
         160: 2f70 6a70 6567 2c20 696d 6167 652f 706e    /pjpeg, image/pn
         176: 672c 202a 2f2a 0d0a 4163 6365 7074 2d43    g, */*..Accept-C
         192: 6861 7273 6574 3a20 6973 6f2d 3838 3539    harset: iso-8859
         208: 2d31 2c2a 2c75 7466 2d38 0d0a 4163 6365    -1,*,utf-8..Acce
         224: 7074 2d45 6e63 6f64 696e 673a 2067 7a69    pt-Encoding: gzi
         240: 700d 0a41 6363 6570 742d 4c61 6e67 7561    p..Accept-Langua
         256: 6765 3a20 656e 0d0a 5573 6572 2d41 6765    ge: en..User-Age
         272: 6e74 3a20 4d6f 7a69 6c6c 612f 342e 3631    nt: Mozilla/4.61
         288: 205b 656e 5d20 2857 696e 3935 3b20 5529     [en] (Win95; U)
         304: 0d0a 0d0a                                  ....

  5   0.02458 141.110.21.7 -> gateway.bfg.com TCP D=62088 S=80 Fin Ack=146627395
8 Seq=96815114 Len=0 Win=8506

           0: 0800 208c f386 00d0 bbd3 16a0 0800 4500    .. ...........E.
          16: 0028 687a 4000 7806 7722 8d6e 1507 83bb    .(hz@.x.w".n....
          32: fd02 0050 f288 05c5 480a 5765 90a6 5011    ...P....H.We..P.
          48: 213a 42b2 0000 0000 0000 0000              !:B.........

  6   0.00780 141.110.21.7 -> gateway.bfg.com TCP D=62088 S=80     Ack=146627395
8 Seq=96813987 Len=1127 Win=8506

           0: 0800 208c f386 00d0 bbd3 16a0 0800 4500    .. ...........E.
          16: 048f 677a 4000 7806 73bb 8d6e 1507 83bb    ..gz@.x.s..n....
          32: fd02 0050 f288 05c5 43a3 5765 90a6 5018    ...P....C.We..P.
          48: 213a 7bf6 0000 4854 5450 2f31 2e31 2032    !:{...HTTP/1.1 2
          64: 3030 204f 4b0d 0a53 6572 7665 723a 204d    00 OK..Server: M
          80: 6963 726f 736f 6674 2d49 4953 2f34 2e30    icrosoft-IIS/4.0
          96: 0d0a 4461 7465 3a20 5765 642c 2030 3520    ..Date: Wed, 05 
         112: 4170 7220 3230 3030 2032 323a 3332 3a35    Apr 2000 22:32:5
         128: 3820 474d 540d 0a43 6f6e 7465 6e74 2d54    8 GMT..Content-T
         144: 7970 653a 2074 6578 742f 6874 6d6c 0d0a    ype: text/html..
         160: 4163 6365 7074 2d52 616e 6765 733a 2062    Accept-Ranges: b
         176: 7974 6573 0d0a 4c61 7374 2d4d 6f64 6966    ytes..Last-Modif
         192: 6965 643a 2046 7269 2c20 3139 204e 6f76    ied: Fri, 19 Nov
         208: 2031 3939 3920 3230 3a35 303a 3534 2047     1999 20:50:54 G
         224: 4d54 0d0a 4554 6167 3a20 2230 3862 3535    MT..ETag: "08b55
         240: 6335 6366 3332 6266 313a 3161 3036 220d    c5cf32bf1:1a06".
         256: 0a43 6f6e 7465 6e74 2d4c 656e 6774 683a    .Content-Length:
         272: 2039 3031 0d0a 0d0a 3c68 746d 6c3e 0d0a     901....<html>..
         288: 3c68 6561 643e 0d0a 3c74 6974 6c65 3e43    <head>..<title>C
         304: 6f75 7273 6549 6e66 6f20 7634 2e30 3c2f    ourseInfo v4.0</
         320: 7469 746c 653e 0d0a 3c2f 6865 6164 3e0d    title>..</head>.
         336: 0a20 2020 3c66 7261 6d65 7365 7420 626f    .   <frameset bo
         352: 7264 6572 3d30 2063 6f6c 733d 2231 3535    rder=0 cols="155
         368: 2c20 2a22 3e0d 0a20 2020 093c 6672 616d    , *">..   .<fram
         384: 6520 7372 633d 222f 6269 6e2f 636f 6d6d    e src="/bin/comm
         400: 6f6e 2f6d 7962 625f 746f 632e 706c 2220    on/mybb_toc.pl" 
         416: 6e61 6d65 3d22 6d79 6262 746f 6322 2062    name="mybbtoc" b
         432: 6f72 6465 723d 3020 6d61 7267 696e 7769    order=0 marginwi
         448: 6474 683d 3220 6d61 7267 696e 6865 6967    dth=2 marginheig
         464: 6874 3d30 2074 6974 6c65 3d22 426c 6163    ht=0 title="Blac
         480: 6b62 6f61 7264 2043 6f75 7273 6549 6e66    kboard CourseInf
         496: 6f20 342e 3022 3e0d 0a20 2020 2020 203c    o 4.0">..      <
         512: 6672 616d 6573 6574 2062 6f72 6465 723d    frameset border=
         528: 3020 726f 7773 3d22 3535 2c20 2a22 3e0d    0 rows="55, *">.
         544: 0a20 2020 2020 2020 2020 3c66 7261 6d65    .         <frame
         560: 2073 7263 3d22 2f62 696e 2f63 6f6d 6d6f     src="/bin/commo
         576: 6e2f 6d79 6262 5f74 6f70 2e70 6c22 206e    n/mybb_top.pl" n
         592: 616d 653d 226d 7962 6274 6f70 2220 626f    ame="mybbtop" bo
         608: 7264 6572 3d30 206d 6172 6769 6e77 6964    rder=0 marginwid
         624: 7468 3d30 206d 6172 6769 6e68 6569 6768    th=0 marginheigh
         640: 743d 3020 7469 746c 653d 2242 6c61 636b    t=0 title="Black
         656: 626f 6172 6420 436f 7572 7365 496e 666f    board CourseInfo
         672: 2034 2e30 223e 0d0a 2020 2009 2020 203c     4.0">..   .   <
         688: 6672 616d 6520 7372 633d 222f 6269 6e2f    frame src="/bin/
         704: 636f 6d6d 6f6e 2f6d 7962 625f 686f 6d65    common/mybb_home
         720: 2e70 6c22 206e 616d 653d 226d 7962 626d    .pl" name="mybbm
         736: 6169 6e22 2062 6f72 6465 723d 3020 6d61    ain" border=0 ma
         752: 7267 696e 7769 6474 683d 3020 6d61 7267    rginwidth=0 marg
         768: 696e 6865 6967 6874 3d30 2074 6974 6c65    inheight=0 title
         784: 3d22 426c 6163 6b62 6f61 7264 2043 6f75    ="Blackboard Cou
         800: 7273 6549 6e66 6f20 342e 3022 3e0d 0a20    rseInfo 4.0">.. 
         816: 2020 093c 2f66 7261 6d65 7365 743e 0d0a      .</frameset>..
         832: 2020 203c 2f66 7261 6d65 7365 743e 0d0a       </frameset>..
         848: 3c62 6f64 7920 6267 636f 6c6f 723d 2223    <body bgcolor="#
         864: 6666 6666 6666 2220 7465 7874 3d22 2330    ffffff" text="#0
         880: 3030 3030 3022 3e0d 0a3c 4e4f 4652 414d    00000">..<NOFRAM
         896: 4553 3e0d 0a43 6f75 7273 6573 2062 7920    ES>..Courses by 
         912: 436f 7572 7365 496e 666f 2076 342e 3020    CourseInfo v4.0 
         928: 6172 6520 6265 7374 2076 6965 7765 6420    are best viewed 
         944: 7769 7468 203c 6120 6872 6566 3d22 6874    with <a href="ht
         960: 7470 3a2f 2f68 6f6d 652e 6e65 7473 6361    tp://home.netsca
         976: 7065 2e63 6f6d 2220 7461 7267 6574 3d5f    pe.com" target=_
         992: 746f 703e 4e65 7473 6361 7065 204e 6176    top>Netscape Nav
        1008: 6967 6174 6f72 3c2f 613e 206f 7220 3c61    igator</a> or <a
        1024: 2068 7265 663d 2268 7474 703a 2f2f 7777     href="http://ww
        1040: 772e 6d69 6372 6f73 6f66 742e 636f 6d22    w.microsoft.com"
        1056: 2074 6172 6765 743d 5f74 6f70 223e 4d69     target=_top">Mi
        1072: 6372 6f73 6f66 7420 496e 7465 726e 6574    crosoft Internet
        1088: 2045 7870 6c6f 7265 723c 2f61 3e2e 0d0a     Explorer</a>...
        1104: 506c 6561 7365 2064 6f77 6e6c 6f61 6420    Please download 
        1120: 6f6e 6520 696e 206f 7264 6572 2074 6f20    one in order to 
        1136: 636f 6e74 696e 7565 2e0d 0a3c 2f62 6f64    continue...</bod
        1152: 793e 0d0a 3c2f 4e4f 4652 414d 4553 3e20    y>..</NOFRAMES> 
        1168: 2020 2020 0d0a 3c2f 6874 6d6c 3e            ..</html>

  7   0.04829 gateway.bfg.com -> 141.110.21.7 TCP D=80 S=62088     Ack=96815114 
Seq=1466273958 Len=0 Win=64240

           0: 00d0 bbd3 16a0 0800 208c f386 0800 4500    ........ .....E.
          16: 0028 79a8 4000 ff06 def3 83bb fd02 8d6e    .(y.@..........n
          32: 1507 f288 0050 5765 90a6 05c5 480a 5010    .....PWe....H.P.
          48: faf0 68fc 0000                             ú.hü..

ns1


>How-To-Repeat:
support.dell.com  (this one is pretty important)
>Fix:
Process gets hung in buff_read while reading to the socket.  It appears that the read doesn't complete (no EOF is sent) hence always returns negative return.

One idea is to return any data read regardless of the final IO status.  Timeouts will still be an issue.
>Release-Note:
>Audit-Trail:

From: Ted Keller <keller@bfg.com>
To: submit@bugz.apache.org, apache-bugdb@apache.org
Cc:  
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)

 Further investigations have shown the following....
 
 1. All pages that are failing are http 1.1 type pages.
 
 2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 checked, seems to help.  Note - netscape 4 does not have an equivalent
 selectable feature.
 
 3. A modification in buff.c as follows... forces "short" timeouts for
 sites that do NOT close connections at the end of a block transmission.
 The modification below set this to 8 seconds - this should really be a
 configurable parameter.
 
 With these, we are starting to see acceptable performance for these "bad"
 sites.
 
 Further guidance is requested.
 
 ted keller
 
 
 ns2.bfg.com 36# diff -c buff.c.orig buff.c
 *** buff.c.orig Wed Apr 12 23:23:36 2000
 --- buff.c      Fri Apr 14 18:05:14 2000
 ***************
 *** 264,270 ****
       rv = recv(fb->fd_in, buf, nbyte, 0);
       } else
       rv = ap_read(fb,buf,nbyte);
 ! #elif defined(TPF)
       fd_set fds;
       struct timeval tv;
   
 --- 264,270 ----
       rv = recv(fb->fd_in, buf, nbyte, 0);
       } else
       rv = ap_read(fb,buf,nbyte);
 ! #elif (defined(TPF) || defined(SOLARIS))
       fd_set fds;
       struct timeval tv;
   
 ***************
 *** 273,279 ****
           alarm(rv = alarm(0));
           FD_ZERO(&fds);
           FD_SET(fb->fd_in, &fds);
 !         tv.tv_sec = rv+1;
           tv.tv_usec = 0;
           rv = ap_select(fb->fd_in + 1, &fds, NULL, NULL, &tv);
           if (rv > 0)
 --- 273,280 ----
           alarm(rv = alarm(0));
           FD_ZERO(&fds);
           FD_SET(fb->fd_in, &fds);
 !         /*tv.tv_sec = rv+1;*/
 !         tv.tv_sec = 8;
           tv.tv_usec = 0;
           rv = ap_select(fb->fd_in + 1, &fds, NULL, NULL, &tv);
           if (rv > 0)
 ns2.bfg.com 37# 
 
 
 

From: Marc Slemko <marcs@znep.com>
To: Ted Keller <keller@bfg.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Fri, 14 Apr 2000 16:49:22 -0600 (MDT)

 On 14 Apr 2000, Ted Keller wrote:
 
 > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > 
 > From: Ted Keller <keller@bfg.com>
 > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > Cc:  
 > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > 
 >  Further investigations have shown the following....
 >  
 >  1. All pages that are failing are http 1.1 type pages.
 >  
 >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 >  selectable feature.
 
 What if you disable all HTTP/1.1 support in IE?
 
 >  
 >  3. A modification in buff.c as follows... forces "short" timeouts for
 >  sites that do NOT close connections at the end of a block transmission.
 >  The modification below set this to 8 seconds - this should really be a
 >  configurable parameter.
 >  
 >  With these, we are starting to see acceptable performance for these "bad"
 >  sites.
 
 Refresh my memory; can you give me a URL that exhibits this problem?
 
 Thanks.
 

From: Ted Keller <keller@bfg.com>
To: Marc Slemko <marcs@znep.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Fri, 14 Apr 2000 19:22:21 -0400 (EDT)

 Marc,
 
 Restored buff.c to original mode.  Turned off http 1.1 processing in the
 browser.  Hit support.dell.com site - browser appears to die (were back to
 using default timeouts).
 
 Netstat -n reports 
 xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 ESTABLISHED
  
 all other connections to that site are in a FIN_WAIT mode.
 
 With the buff.c modification, and http 1.1 support turned off, performance
 improves to near acceptable. However, we still wait for the connection to
 close which never does until the short timeout is reached.
 
 Direct connections show this pages loads in about 2 seconds.
 With the "fix" page loads in about 30 seconds
 Without the "fix" page fails to load.
 
 Obviously I like the 2 second loads....
 
 
 On Fri, 14 Apr 2000, Marc Slemko wrote:
 
 > On 14 Apr 2000, Ted Keller wrote:
 > 
 > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > 
 > > From: Ted Keller <keller@bfg.com>
 > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > Cc:  
 > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > 
 > >  Further investigations have shown the following....
 > >  
 > >  1. All pages that are failing are http 1.1 type pages.
 > >  
 > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > >  selectable feature.
 > 
 > What if you disable all HTTP/1.1 support in IE?
 > 
 > >  
 > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > >  sites that do NOT close connections at the end of a block transmission.
 > >  The modification below set this to 8 seconds - this should really be a
 > >  configurable parameter.
 > >  
 > >  With these, we are starting to see acceptable performance for these "bad"
 > >  sites.
 > 
 > Refresh my memory; can you give me a URL that exhibits this problem?
 > 
 
 
 support.dell.com
 
 We have also seen this on...
 
 www.bell.ca
 www.winntmag.com
 www.nai.com
 
 > Thanks.
 > 
 

From: Marc Slemko <marcs@znep.com>
To: Ted Keller <keller@bfg.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Fri, 14 Apr 2000 19:21:12 -0600 (MDT)

 On Fri, 14 Apr 2000, Ted Keller wrote:
 
 > Marc,
 > 
 > Restored buff.c to original mode.  Turned off http 1.1 processing in the
 > browser.  Hit support.dell.com site - browser appears to die (were back to
 > using default timeouts).
 
 So you mean just going to http://support.dell.com/ ?
 
 Have you tried a more recent version of Apache?
 
 Do other browsers have the same problem?
 
 I'm having trouble reproducing it.
 
 > 
 > Netstat -n reports 
 > xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 > ESTABLISHED
 >  
 > all other connections to that site are in a FIN_WAIT mode.
 > 
 > With the buff.c modification, and http 1.1 support turned off, performance
 > improves to near acceptable. However, we still wait for the connection to
 > close which never does until the short timeout is reached.
 > 
 > Direct connections show this pages loads in about 2 seconds.
 > With the "fix" page loads in about 30 seconds
 > Without the "fix" page fails to load.
 > 
 > Obviously I like the 2 second loads....
 > 
 > 
 > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > 
 > > On 14 Apr 2000, Ted Keller wrote:
 > > 
 > > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > > 
 > > > From: Ted Keller <keller@bfg.com>
 > > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > > Cc:  
 > > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > > 
 > > >  Further investigations have shown the following....
 > > >  
 > > >  1. All pages that are failing are http 1.1 type pages.
 > > >  
 > > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > > >  selectable feature.
 > > 
 > > What if you disable all HTTP/1.1 support in IE?
 > > 
 > > >  
 > > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > > >  sites that do NOT close connections at the end of a block transmission.
 > > >  The modification below set this to 8 seconds - this should really be a
 > > >  configurable parameter.
 > > >  
 > > >  With these, we are starting to see acceptable performance for these "bad"
 > > >  sites.
 > > 
 > > Refresh my memory; can you give me a URL that exhibits this problem?
 > > 
 > 
 > 
 > support.dell.com
 > 
 > We have also seen this on...
 > 
 > www.bell.ca
 > www.winntmag.com
 > www.nai.com
 > 
 > > Thanks.
 > > 
 > 
 

From: Ted Keller <keller@bfg.com>
To: Marc Slemko <marcs@znep.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Fri, 14 Apr 2000 22:24:20 -0400 (EDT)

 Hmmm....
 
 I'm starting to wonder if this is a Solaris issue....
 
 I noted a message on the apache news group titled
 
  Apache Timeout problems on SPARC Solaris
 
 where the author indicated timing problems on solaris that were not
 evident in linux.
 
 Answers to your questions...
 
 http://support.dell.com is the site.  It just doesn't download without
 timeout logic.  If you can't reproduce that - maybe this is somehow os
 related.
 
 1.3.9 is my standard release.  I've noted the code in 1.3.12 and 2.0 alpha
 release was unchanged in this area.  Did not test them - will do that
 Sunday.
 
 Browsers - I've had reports for various versions of Netscape and IE.  Also
 hit it with lynx and had similar experience.  It seems to be browser
 independent.
 
 Again, I will try the later releases Sunday and report.  I don't have
 ready access to another type of box - but will see what I can do.
 
 Will report back later.
 
 ted keller
 
 
 
 On Fri, 14 Apr 2000, Marc Slemko wrote:
 
 > On Fri, 14 Apr 2000, Ted Keller wrote:
 > 
 > > Marc,
 > > 
 > > Restored buff.c to original mode.  Turned off http 1.1 processing in the
 > > browser.  Hit support.dell.com site - browser appears to die (were back to
 > > using default timeouts).
 > 
 > So you mean just going to http://support.dell.com/ ?
 > 
 > Have you tried a more recent version of Apache?
 > 
 > Do other browsers have the same problem?
 > 
 > I'm having trouble reproducing it.
 > 
 > > 
 > > Netstat -n reports 
 > > xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 > > ESTABLISHED
 > >  
 > > all other connections to that site are in a FIN_WAIT mode.
 > > 
 > > With the buff.c modification, and http 1.1 support turned off, performance
 > > improves to near acceptable. However, we still wait for the connection to
 > > close which never does until the short timeout is reached.
 > > 
 > > Direct connections show this pages loads in about 2 seconds.
 > > With the "fix" page loads in about 30 seconds
 > > Without the "fix" page fails to load.
 > > 
 > > Obviously I like the 2 second loads....
 > > 
 > > 
 > > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > > 
 > > > On 14 Apr 2000, Ted Keller wrote:
 > > > 
 > > > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > > > 
 > > > > From: Ted Keller <keller@bfg.com>
 > > > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > > > Cc:  
 > > > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > > > 
 > > > >  Further investigations have shown the following....
 > > > >  
 > > > >  1. All pages that are failing are http 1.1 type pages.
 > > > >  
 > > > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > > > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > > > >  selectable feature.
 > > > 
 > > > What if you disable all HTTP/1.1 support in IE?
 > > > 
 > > > >  
 > > > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > > > >  sites that do NOT close connections at the end of a block transmission.
 > > > >  The modification below set this to 8 seconds - this should really be a
 > > > >  configurable parameter.
 > > > >  
 > > > >  With these, we are starting to see acceptable performance for these "bad"
 > > > >  sites.
 > > > 
 > > > Refresh my memory; can you give me a URL that exhibits this problem?
 > > > 
 > > 
 > > 
 > > support.dell.com
 > > 
 > > We have also seen this on...
 > > 
 > > www.bell.ca
 > > www.winntmag.com
 > > www.nai.com
 > > 
 > > > Thanks.
 > > > 
 > > 
 > 
 

From: Ted Keller <keller@bfg.com>
To: Marc Slemko <marcs@znep.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Sun, 16 Apr 2000 15:27:27 -0400 (EDT)

 Marc,
 
 Latest updates.
 
 I built apache for an AIX 4.3.1 system.  Apache exhibited the same issues
 with support.dell.com - hung there until the connection eventually timed
 out.
 
 I tried going to this site with the tis http-gw.  Noted that it also
 "hung" there until the connections timed out - however, data was returned
 to the client.  Lingering connections stayed inplace until the timeout
 completed.
 
 General timings are as follows..
 
 Client native to support.dell.com via socks5 gateway - 3 seconds
 
 Client (IE5) to support.dell.com via TIS http-gw - 6 seconds
 	(timeouts completed around 9 seconds from page request).
 
 Client (IE5) to support.dell.com with short timeout in buff.c - 50 seconds
 
 Client IE5) to support.dell.com via apache without short timeout -
 never....     Note - same symptoms for both Solaris and AIX
 
 
 Current thoughts....
 
 IIS is breaking protocol.  They do not seem to be sending an EOF at the
 termination of the HTTP 1.x page.  That's bad because it breaks about
 every proxy server out there....
 
 Clients display the data as they get it.  If the eof doesn't occur - they
 timeout out the sessions after the last read.  User does not see impact.
 However, firewalls.... may be hanging long-term connections (Mine seems
 to).
 
 I've attached below a solaris "truss" which shows all system calls - and a
 gdb debug session - stepping through the ap_proxy_send_fb routine.  Both
 show long term hangs during the final read waiting for a timeout to occur
 or an EOF to be received.
 
 Suggestions....
 
 Since this may take awhile for Microsoft to identify and correct the
 problem - and even longer for Internet sites to implement the desired
 service pack level, it seems that we need to implement a short timeout
 variable logic algorithm.  The general crux of the algorithm will be as
 follows:
 
 1. default to some short timeout value - say 10 seconds for a connection.
 this should be configurable.
 
 2. based on prior block reads from a host for that session, calculate the
 connection speed on the completion of each block read.
 
 3. add a small safety factor (local line congestion).
 
 4. modify short timeout value for next read to match session transfer
 speed.
 
 5. If timeout occurs - assume EOF.... terminate the connection.
 
 Feed back any thoughts...
 
 Many thanks
 
 ted keller
 
 
 send(4, " G E T   /   H T T P / 1".., 442, 0)   = 442
 alarm(0)                                        = 300
 alarm(300)                                      = 0
 getsockname(4, 0xFFBED1A8, 0xFFBED2B4, 1)       = 0
 getsockopt(4, 65535, 4104, 0xFFBED2BC, 0xFFBED2B8, 1) = 0
 recv(4, " H T T P / 1 . 1   3 0 2".., 4096, 0)  = 384
 alarm(0)                                        = 300
 unlink("/scratch/apache/Y/i/G/PRwpDwnn92dVl2yo7ZA") Err#2 ENOENT
 alarm(300)                                      = 0
 alarm(0)                                        = 300
 alarm(0)                                        = 0
 alarm(300)                                      = 0
 getsockname(4, 0xFFBEB128, 0xFFBEB234, 1)       = 0
 getsockopt(4, 65535, 4104, 0xFFBEB23C, 0xFFBEB238, 1) = 0
 recv(4, 0xFFBEB61D, 8059, 0)    (sleeping...)
 recv(4, 0xFFBEB61D, 8059, 0)    (sleeping...)  DIED HERE....
 
 
 
 ns2.bfg.com 201# gdb
 GNU gdb 4.18
 Copyright 1998 Free Software Foundation, Inc.
 GDB is free software, covered by the GNU General Public License, and you are
 welcome to change it and/or distribute copies of it under certain conditions.
 Type "show copying" to see the conditions.
 There is absolutely no warranty for GDB.  Type "show warranty" for details.
 This GDB was configured as "sparc-sun-solaris2.7".
 (gdb) file httpd
 Reading symbols from httpd...done.
 (gdb) break ap_proxy_send_fb
 Breakpoint 1 at 0x29c38: file proxy_util.c, line 498.
 (gdb) run -X
 Starting program: /usr/local/apache-test/sbin/httpd -X
 
 Breakpoint 1, ap_proxy_send_fb (f=0x1027d0, r=0x101b00, c=0x102708)
     at proxy_util.c:498
 498         conn_rec *con = r->connection;
 (gdb) s
 499         int alternate_timeouts = 1; /* 1 if we alternate between soft & hard
  timeouts */
 (gdb) s
 501         total_bytes_rcvd = 0;
 (gdb) s
 502         if (c != NULL)
 (gdb) s
 503             c->written = 0;
 (gdb) s
 518         ap_kill_timeout(r);
 (gdb) s
 ap_kill_timeout (dummy=0x101b00) at http_main.c:1322
 1322        ap_set_callback_and_alarm(NULL, 0);
 (gdb) s
 ap_set_callback_and_alarm (fn=0, x=0) at http_main.c:1220
 1220        if (alarm_fn && x && fn != alarm_fn) {
 (gdb) s
 1224        alarm_fn = fn;
 (gdb) s
 1228        if (child_timeouts) {
 (gdb) s
 1229            old = alarm(x);
 (gdb) s
 1230        }
 (gdb) s
 1242        return (old);
 (gdb) s
 1243    }
 (gdb) s
 ap_kill_timeout (dummy=0x101b00) at http_main.c:1323
 1323        timeout_req = NULL;
 (gdb) s
 1324        timeout_name = NULL;
 (gdb) s
 1325    }
 (gdb) s
 ap_proxy_send_fb (f=0x1027d0, r=0x101b00, c=0x102708) at proxy_util.c:533
 533         if (c == NULL || c->len <= 0 || c->cache_completion == 1.0) {
 (gdb) s
 534             ap_hard_timeout("proxy send body", r);
 (gdb) s
 ap_hard_timeout (name=0xb8858 "proxy send body", r=0x101b00)
     at http_main.c:1304
 1304        timeout_req = r;
 (gdb) s
 1305        timeout_name = name;
 (gdb) s
 1307        ap_set_callback_and_alarm(timeout, r->server->timeout);
 (gdb) s
 ap_set_callback_and_alarm (fn=0x4b860 <timeout>, x=300) at http_main.c:1220
 1220        if (alarm_fn && x && fn != alarm_fn) {
 (gdb) s
 1224        alarm_fn = fn;
 (gdb) s
 1228        if (child_timeouts) {
 (gdb) s
 1229            old = alarm(x);
 (gdb) s
 1230        }
 (gdb) s
 1242        return (old);
 (gdb) s
 1243    }
 (gdb) s
 ap_hard_timeout (name=0xb8858 "proxy send body", r=0x101b00)
     at http_main.c:1309
 1309    }
 (gdb) s
 ap_proxy_send_fb (f=0x1027d0, r=0x101b00, c=0x102708) at proxy_util.c:535
 535             alternate_timeouts = 0;
 (gdb) s
 543         for (ok = 1; ok; ) {
 (gdb) s
 544             if (alternate_timeouts)
 (gdb) s
 548             n = ap_bread(f, buf, IOBUFSIZE);
 (gdb) s
 ap_bread (fb=0x1027d0, buf=0xffbeb560, nbyte=8192) at buff.c:709
 709         if (fb->flags & B_RDERR)
 (gdb) s
 711         if (nbyte == 0)
 (gdb) s
 714         if (!(fb->flags & B_RD)) {
 (gdb) s
 737         nrd = fb->incnt;
 (gdb) s
 739         if (nrd >= nbyte) {
 (gdb) print nbyte
 $1 = 8192
 (gdb) print nrd
 $2 = 133
 (gdb) s
 751         if (nrd > 0) {
 (gdb) s
 757             memcpy(buf, fb->inptr, nrd);
 (gdb) s
 758             nbyte -= nrd;
 (gdb) s
 759             buf = nrd + (char *) buf;
 (gdb) s
 760             fb->incnt = 0;
 (gdb) s
 762         if (fb->flags & B_EOF)
 (gdb) s
 766         if (nbyte >= fb->bufsiz) {
 (gdb) s
 768             i = read_with_errors(fb, buf, nbyte);
 (gdb) s
 read_with_errors (fb=0x1027d0, buf=0xffbeb5e5, nbyte=8059) at buff.c:686
 686         rv = saferead(fb, buf, nbyte);
 (gdb) s
 saferead_guts (fb=0x1027d0, buf=0xffbeb5e5, nbyte=8059) at buff.c:631
 631         if (fb->flags & B_SAFEREAD) {
 (gdb) s
 635             rv = buff_read(fb, buf, nbyte);
 (gdb) s
 buff_read (fb=0x1027d0, buf=0xffbeb5e5, nbyte=8059) at buff.c:287
 287         rv = ap_read(fb, buf, nbyte);
 (gdb) s
 ap_read (fb=0x1027d0, buf=0xffbeb5e5, nbyte=8059) at buff.c:245
 245             rv = read(fb->fd_in, buf, nbyte);
 (gdb) s  - LONG Hang TIME HERE
 
 Program exited normally.
 (gdb) 
 
 On Fri, 14 Apr 2000, Marc Slemko wrote:
 
 > On Fri, 14 Apr 2000, Ted Keller wrote:
 > 
 > > Marc,
 > > 
 > > Restored buff.c to original mode.  Turned off http 1.1 processing in the
 > > browser.  Hit support.dell.com site - browser appears to die (were back to
 > > using default timeouts).
 > 
 > So you mean just going to http://support.dell.com/ ?
 > 
 > Have you tried a more recent version of Apache?
 > 
 > Do other browsers have the same problem?
 > 
 > I'm having trouble reproducing it.
 > 
 > > 
 > > Netstat -n reports 
 > > xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 > > ESTABLISHED
 > >  
 > > all other connections to that site are in a FIN_WAIT mode.
 > > 
 > > With the buff.c modification, and http 1.1 support turned off, performance
 > > improves to near acceptable. However, we still wait for the connection to
 > > close which never does until the short timeout is reached.
 > > 
 > > Direct connections show this pages loads in about 2 seconds.
 > > With the "fix" page loads in about 30 seconds
 > > Without the "fix" page fails to load.
 > > 
 > > Obviously I like the 2 second loads....
 > > 
 > > 
 > > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > > 
 > > > On 14 Apr 2000, Ted Keller wrote:
 > > > 
 > > > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > > > 
 > > > > From: Ted Keller <keller@bfg.com>
 > > > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > > > Cc:  
 > > > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > > > 
 > > > >  Further investigations have shown the following....
 > > > >  
 > > > >  1. All pages that are failing are http 1.1 type pages.
 > > > >  
 > > > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > > > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > > > >  selectable feature.
 > > > 
 > > > What if you disable all HTTP/1.1 support in IE?
 > > > 
 > > > >  
 > > > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > > > >  sites that do NOT close connections at the end of a block transmission.
 > > > >  The modification below set this to 8 seconds - this should really be a
 > > > >  configurable parameter.
 > > > >  
 > > > >  With these, we are starting to see acceptable performance for these "bad"
 > > > >  sites.
 > > > 
 > > > Refresh my memory; can you give me a URL that exhibits this problem?
 > > > 
 > > 
 > > 
 > > support.dell.com
 > > 
 > > We have also seen this on...
 > > 
 > > www.bell.ca
 > > www.winntmag.com
 > > www.nai.com
 > > 
 > > > Thanks.
 > > > 
 > > 
 > 
 

From: Ted Keller <keller@bfg.com>
To: Marc Slemko <marcs@znep.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Thu, 27 Apr 2000 20:09:07 -0400 (EDT)

 Mark,
 
 I'm still looking at this.  What I've discovered is as follows....
 
 Certain iis 4.x sites are not sending the <fin> packets when closing the
 tcp connection.  I've verified this with the site operators.  My
 understanding of the tcp protocol is this packet is required to close the
 session.  Once closed, the read in apache should get the end of file
 indicator - thus allowing the data to be sent to the client.
 
 Is my understanding correct?
 
 I'm still curious as to why you can't reproduce the problem.  Can you
 provide any input?
 
 tnx
 ted keller
 
 
 On Fri, 14 Apr 2000, Marc Slemko wrote:
 
 > On Fri, 14 Apr 2000, Ted Keller wrote:
 > 
 > > Marc,
 > > 
 > > Restored buff.c to original mode.  Turned off http 1.1 processing in the
 > > browser.  Hit support.dell.com site - browser appears to die (were back to
 > > using default timeouts).
 > 
 > So you mean just going to http://support.dell.com/ ?
 > 
 > Have you tried a more recent version of Apache?
 > 
 > Do other browsers have the same problem?
 > 
 > I'm having trouble reproducing it.
 > 
 > > 
 > > Netstat -n reports 
 > > xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 > > ESTABLISHED
 > >  
 > > all other connections to that site are in a FIN_WAIT mode.
 > > 
 > > With the buff.c modification, and http 1.1 support turned off, performance
 > > improves to near acceptable. However, we still wait for the connection to
 > > close which never does until the short timeout is reached.
 > > 
 > > Direct connections show this pages loads in about 2 seconds.
 > > With the "fix" page loads in about 30 seconds
 > > Without the "fix" page fails to load.
 > > 
 > > Obviously I like the 2 second loads....
 > > 
 > > 
 > > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > > 
 > > > On 14 Apr 2000, Ted Keller wrote:
 > > > 
 > > > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > > > 
 > > > > From: Ted Keller <keller@bfg.com>
 > > > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > > > Cc:  
 > > > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > > > 
 > > > >  Further investigations have shown the following....
 > > > >  
 > > > >  1. All pages that are failing are http 1.1 type pages.
 > > > >  
 > > > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > > > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > > > >  selectable feature.
 > > > 
 > > > What if you disable all HTTP/1.1 support in IE?
 > > > 
 > > > >  
 > > > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > > > >  sites that do NOT close connections at the end of a block transmission.
 > > > >  The modification below set this to 8 seconds - this should really be a
 > > > >  configurable parameter.
 > > > >  
 > > > >  With these, we are starting to see acceptable performance for these "bad"
 > > > >  sites.
 > > > 
 > > > Refresh my memory; can you give me a URL that exhibits this problem?
 > > > 
 > > 
 > > 
 > > support.dell.com
 > > 
 > > We have also seen this on...
 > > 
 > > www.bell.ca
 > > www.winntmag.com
 > > www.nai.com
 > > 
 > > > Thanks.
 > > > 
 > > 
 > 
 

From: Ted Keller <keller@bfg.com>
To: Marc Slemko <marcs@znep.com>
Cc: Apache bugs database <apbugs@apache.org>
Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
Date: Wed, 10 May 2000 19:17:13 -0400 (EDT)

 Marc,
 
 I've solved the problem.....  Apache mods are attached.
 
 The problem is still caused by some internet sites not properly closing
 connections (missing <fin>) which causes apache to go into a long wait
 - waiting for the read to complete.
 
 
 There are three issues that I had to deal with.
 
 1. Apache normally reads data from the remote server until it receives an
 EOF - or unitl a "data block" is full prior to issuing hte data to the
 client.  Apache wants to reblock the data for more efficient tcp
 transmissions - wanting to send larger blocks instead of the blocks read
 from the internet.  Patch 1 then deals with flushing the data to the
 client as it is received from the net - thus ignoring the reblocking
 features.  This make apache appear to have equivalent performance as a
 client running native to one of these sites.
 
 2. Apache also tends to want to buffer up the receive side - performing
 multiple network reads to fill a block prior to passing it back to the
 internal caching routines and then sending it on to the client.  This does
 have server perfrormance ramifications - since without this buffering, the
 apache caching routines now have to work a bit harder.  The second patch
 places the apache into a "non" buffered read mode - such that each block
 is passed back as it is received.  No multi-buffering for performance is
 performed.  So I work my disks a bit harder....  
 
 This then allows the client to get the last block of data as issued by the
 remote server.
 
 3.  The third item is to then ratchet down the connection timeouts.
 Apache will still try to read that missing EOF.  But since the EOF never
 arrives, the process will hang until the timeout is received.  In standard
 configurations - this is 300 seconds.  If I have a particularly bad site -
 this will consume a number of processes until this timeout is reached.  By
 reducing this to about 60 seconds, we see a reasonable compromise.  Note -
 if this problem tends to poliferate, we may have to increase the number of
 available process slots for the apache to run in.
 
 Note - the attached mods also contain fixes to allow apache to work better
 with socks5.  These are limited to extra close statements in the code.
 
 The important mods are the ap_bflush additions and the modification of the
 flags on the input side to permit non-buffered reading.
 
 
 Here are the diff files for proxy_http.c (1.3.9)
 
 *** proxy_http.c.orig	Sat Sep 18 22:46:53 1999
 --- proxy_http.c	Fri May  5 22:21:29 2000
 ***************
 *** 289,305 ****
       }
   #endif
       if (i == -1) {
 ! 	if (proxyhost != NULL)
   	    return DECLINED;	/* try again another way */
 ! 	else
   	    return ap_proxyerror(r, HTTP_BAD_GATEWAY, ap_pstrcat(r->pool,
   				"Could not connect to remote machine: ",
   				strerror(errno), NULL));
       }
   
       clear_connection(r->pool, r->headers_in);	/* Strip connection-based headers */
   
 !     f = ap_bcreate(p, B_RDWR | B_SOCKET);
       ap_bpushfd(f, sock, sock);
   
       ap_hard_timeout("proxy send", r);
 --- 289,308 ----
       }
   #endif
       if (i == -1) {
 ! 	if (proxyhost != NULL) {
 ! 	    ap_pclosesocket(p,sock);
   	    return DECLINED;	/* try again another way */
 ! 	}else {
 ! 	    ap_pclosesocket(p,sock);
   	    return ap_proxyerror(r, HTTP_BAD_GATEWAY, ap_pstrcat(r->pool,
   				"Could not connect to remote machine: ",
   				strerror(errno), NULL));
 + 	}
       }
   
       clear_connection(r->pool, r->headers_in);	/* Strip connection-based headers */
   
 !     f = ap_bcreate(p, B_RDWR | B_SOCKET); 
       ap_bpushfd(f, sock, sock);
   
       ap_hard_timeout("proxy send", r);
 ***************
 *** 370,380 ****
 --- 373,385 ----
   	ap_log_rerror(APLOG_MARK, APLOG_ERR, r,
   		     "ap_bgets() - proxy receive - Error reading from remote server %s (length %d)",
   		     proxyhost ? proxyhost : desthost, len);
 + 	ap_pclosesocket(p,sock);
   	return ap_proxyerror(r, HTTP_BAD_GATEWAY,
   			     "Error reading from remote server");
       } else if (len == 0) {
   	ap_bclose(f);
   	ap_kill_timeout(r);
 + 	ap_pclosesocket(p,sock);
   	return ap_proxyerror(r, HTTP_BAD_GATEWAY,
   			     "Document contains no data");
       }
 ***************
 *** 391,396 ****
 --- 396,402 ----
   	if (buffer[5] != '1' || buffer[len - 1] != '\n') {
   	    ap_bclose(f);
   	    ap_kill_timeout(r);
 + 	    ap_pclosesocket(p,sock);
   	    return HTTP_BAD_GATEWAY;
   	}
   	backasswards = 0;
 ***************
 *** 435,442 ****
   	}
   
   	clear_connection(p, resp_hdrs);	/* Strip Connection hdrs */
 !     }
 !     else {
   /* an http/0.9 response */
   	backasswards = 1;
   	r->status = 200;
 --- 441,447 ----
   	}
   
   	clear_connection(p, resp_hdrs);	/* Strip Connection hdrs */
 !     } else {
   /* an http/0.9 response */
   	backasswards = 1;
   	r->status = 200;
 ***************
 *** 476,481 ****
 --- 481,487 ----
       i = ap_proxy_cache_update(c, resp_hdrs, !backasswards, nocache);
       if (i != DECLINED) {
   	ap_bclose(f);
 + 	ap_pclosesocket(p,sock);
   	return i;
       }
   
 ***************
 *** 515,520 ****
 --- 521,527 ----
   	    c = ap_proxy_cache_error(c);
   	}
       }
 +     ap_bflush(r->connection->client);
       ap_kill_timeout(r);
   
   #ifdef CHARSET_EBCDIC
 ***************
 *** 539,543 ****
 --- 546,551 ----
       ap_bclose(f);
   
       ap_proxy_garbage_coll(r);
 +     ap_pclosesocket(p,sock);
       return OK;
   }
 
 
 mods for proxy_util.c
 
 *** proxy_util.c.orig	Sat May  1 13:02:29 1999
 --- proxy_util.c	Fri May  5 22:57:36 2000
 ***************
 *** 540,545 ****
 --- 540,549 ----
        * or (after the client aborted) while we can successfully
        * read and finish the configured cache_completion.
        */
 +     /*
 +      * clear the buffer read flag
 +      */
 +     f->flags=f->flags & ~B_RD;
       for (ok = 1; ok; ) {
           if (alternate_timeouts)
               ap_hard_timeout("proxy recv body from upstream server", r);
 ***************
 *** 583,588 ****
 --- 587,593 ----
                   ap_soft_timeout("proxy send body", r);
   
               w = ap_bwrite(con->client, &buf[o], n);
 + 	    ap_bflush(con->client);
   
               if (alternate_timeouts)
                   ap_kill_timeout(r);
 ***************
 *** 1238,1252 ****
   int ap_proxy_doconnect(int sock, struct sockaddr_in *addr, request_rec *r)
   {
       int i;
   
       ap_hard_timeout("proxy connect", r);
       do {
   	i = connect(sock, (struct sockaddr *) addr, sizeof(struct sockaddr_in));
   #ifdef WIN32
   	if (i == SOCKET_ERROR)
   	    errno = WSAGetLastError();
   #endif /* WIN32 */
 !     } while (i == -1 && errno == EINTR);
       if (i == -1) {
   	ap_log_rerror(APLOG_MARK, APLOG_ERR, r,
   		     "proxy connect to %s port %d failed",
 --- 1243,1265 ----
   int ap_proxy_doconnect(int sock, struct sockaddr_in *addr, request_rec *r)
   {
       int i;
 +     int connect_count;
   
 + #ifndef CONNECT_RETRY
 + #define CONNECT_RETRY 1
 + #endif /* CONNECT_RETRY */
 + 
 +     connect_count=0;
 + 
       ap_hard_timeout("proxy connect", r);
       do {
   	i = connect(sock, (struct sockaddr *) addr, sizeof(struct sockaddr_in));
 + 	connect_count++;
   #ifdef WIN32
   	if (i == SOCKET_ERROR)
   	    errno = WSAGetLastError();
   #endif /* WIN32 */
 !     } while (i == -1 && errno == EINTR || i == -1 && errno == ECONNREFUSED && connect_count < CONNECT_RETRY);
       if (i == -1) {
   	ap_log_rerror(APLOG_MARK, APLOG_ERR, r,
   		     "proxy connect to %s port %d failed",
 
 
 
 On Thu, 27 Apr 2000, Ted Keller wrote:
 
 > Mark,
 > 
 > I'm still looking at this.  What I've discovered is as follows....
 > 
 > Certain iis 4.x sites are not sending the <fin> packets when closing the
 > tcp connection.  I've verified this with the site operators.  My
 > understanding of the tcp protocol is this packet is required to close the
 > session.  Once closed, the read in apache should get the end of file
 > indicator - thus allowing the data to be sent to the client.
 > 
 > Is my understanding correct?
 > 
 > I'm still curious as to why you can't reproduce the problem.  Can you
 > provide any input?
 > 
 > tnx
 > ted keller
 > 
 > 
 > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > 
 > > On Fri, 14 Apr 2000, Ted Keller wrote:
 > > 
 > > > Marc,
 > > > 
 > > > Restored buff.c to original mode.  Turned off http 1.1 processing in the
 > > > browser.  Hit support.dell.com site - browser appears to die (were back to
 > > > using default timeouts).
 > > 
 > > So you mean just going to http://support.dell.com/ ?
 > > 
 > > Have you tried a more recent version of Apache?
 > > 
 > > Do other browsers have the same problem?
 > > 
 > > I'm having trouble reproducing it.
 > > 
 > > > 
 > > > Netstat -n reports 
 > > > xxx.xxx.xxx.xxx.59939  143.166.82.190.80    17152      0 64240      0
 > > > ESTABLISHED
 > > >  
 > > > all other connections to that site are in a FIN_WAIT mode.
 > > > 
 > > > With the buff.c modification, and http 1.1 support turned off, performance
 > > > improves to near acceptable. However, we still wait for the connection to
 > > > close which never does until the short timeout is reached.
 > > > 
 > > > Direct connections show this pages loads in about 2 seconds.
 > > > With the "fix" page loads in about 30 seconds
 > > > Without the "fix" page fails to load.
 > > > 
 > > > Obviously I like the 2 second loads....
 > > > 
 > > > 
 > > > On Fri, 14 Apr 2000, Marc Slemko wrote:
 > > > 
 > > > > On 14 Apr 2000, Ted Keller wrote:
 > > > > 
 > > > > > The following reply was made to PR mod_proxy/5972; it has been noted by GNATS.
 > > > > > 
 > > > > > From: Ted Keller <keller@bfg.com>
 > > > > > To: submit@bugz.apache.org, apache-bugdb@apache.org
 > > > > > Cc:  
 > > > > > Subject: Re: mod_proxy/5972: Proxy cannot connect to many IIS 4.0 sites
 > > > > > Date: Fri, 14 Apr 2000 18:17:41 -0400 (EDT)
 > > > > > 
 > > > > >  Further investigations have shown the following....
 > > > > >  
 > > > > >  1. All pages that are failing are http 1.1 type pages.
 > > > > >  
 > > > > >  2. IE5 has an option, Use HTTP 1.1 through proxy connections, which, if
 > > > > >  checked, seems to help.  Note - netscape 4 does not have an equivalent
 > > > > >  selectable feature.
 > > > > 
 > > > > What if you disable all HTTP/1.1 support in IE?
 > > > > 
 > > > > >  
 > > > > >  3. A modification in buff.c as follows... forces "short" timeouts for
 > > > > >  sites that do NOT close connections at the end of a block transmission.
 > > > > >  The modification below set this to 8 seconds - this should really be a
 > > > > >  configurable parameter.
 > > > > >  
 > > > > >  With these, we are starting to see acceptable performance for these "bad"
 > > > > >  sites.
 > > > > 
 > > > > Refresh my memory; can you give me a URL that exhibits this problem?
 > > > > 
 > > > 
 > > > 
 > > > support.dell.com
 > > > 
 > > > We have also seen this on...
 > > > 
 > > > www.bell.ca
 > > > www.winntmag.com
 > > > www.nai.com
 > > > 
 > > > > Thanks.
 > > > > 
 > > > 
 > > 
 > 
 > 
 
>Unformatted:
 [In order for any reply to be added to the PR database, you need]
 [to include <apbugs@Apache.Org> in the Cc line and make sure the]
 [subject line starts with the report component and number, with ]
 [or without any 'Re:' prefixes (such as "general/1098:" or      ]
 ["Re: general/1098:").  If the subject doesn't match this       ]
 [pattern, your message will be misfiled and ignored.  The       ]
 ["apbugs" address is not added to the Cc line of messages from  ]
 [the database automatically because of the potential for mail   ]
 [loops.  If you do not include this Cc, your reply may be ig-   ]
 [nored unless you are responding to an explicit request from a  ]
 [developer.  Reply only with text; DO NOT SEND ATTACHMENTS!     ]
 
 

